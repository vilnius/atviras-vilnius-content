title = "Informaciniai pranešimai"
url = "/informaciniai-pranesimai"
layout = "default"
is_hidden = 0
contentType = "html"
==
<?php
function onStart()
{
    $filter=array();
    foreach($_GET['filter'] as $k=>$f){
        if(!empty($f))
        switch($k){
            case 'address':
            case 'receiver':
            case 'planned_work':
            case 'county':
                $filterVals[$k]=$f;
                $filter[]=$k."=:".$k;
                break;
            default:
                break;
        }
    }
    
    
    $this['counties'] = Db::select('SELECT c.id, c.title, COUNT(n.id) AS cnt FROM county c LEFT JOIN notification n ON n.county=c.id GROUP BY c.id, c.title ORDER BY title');
    $v=Db::select('SELECT COUNT(n.id) AS cnt FROM notification n WHERE n.county=0');
    $this['v_cnt'] = $v[0]->cnt;    
    
    $v=Db::select('SELECT COUNT(n.id) AS cnt FROM notification n');
    $this['t_cnt'] = $v[0]->cnt;
    
    $this['rss']='<link rel="alternate" type="application/rss+xml" title="Informaciniai pranešimai" href="http://atviras.vilnius.lt/informaciniai-pranesimai-rss" />';
    
    if(isset($_GET['county'])){
        
    
    $this['rss']='<link rel="alternate" type="application/rss+xml" title="Informaciniai pranešimai" href="http://atviras.vilnius.lt/informaciniai-pranesimai-rss?county='.intval($_GET['county']).'" />';
    $this['notifications'] = Db::select('SELECT n.*, c.title AS county FROM notification n LEFT JOIN county c ON n.county=c.id WHERE n.county=:county ORDER BY date DESC', ['county' => intval($_GET['county'])]);
    $county=Db::select('SELECT * FROM county c WHERE c.id=:county', ['county' => intval($_GET['county'])]);
    $this['county'] = $county[0];
    }
    else{
    $this['all']=true;
    $this['notifications'] = Db::select('SELECT n.*, c.title AS county FROM notification n LEFT JOIN county c ON n.county=c.id ORDER BY date DESC LIMIT 50');
    }
}
?>
==
<style type="text/css">
    .counties{
        margin:0;
        padding:0;
    }
    .counties .filter a{
        display:block;
        padding:10px;
        margin: 0px 5px 5px 0px;
        width:30%;
        float:left;
        border:3px solid #16a085;
    }
    .counties .filter a:hover{
        color:#fff;
        background:#16a085;
    }
    .type {
        display:block;
        height: 68px;
        width: 80px;
    }
    .treePermit{
        background-image:url('{{ 'assets/images/medziai.png'|theme }}');
        background-repeat:no-repeat;
        background-size: contain;
    }
    .planning{
        background-image:url('{{ 'assets/images/planai.png'|theme }}');
        background-repeat:no-repeat;
        background-size: contain;
    }
</style>

<div class="container">
    
    <div class="row">
        <div class="col-md-12">
            
            <h3>Seniūnijos</h3>
            
            <div class="counties">
                <div class="filter"><a href="/informaciniai-pranesimai">Visos ({{ t_cnt }})</a></div>
                <div class="filter"><a href="?county=0">Nenurodyta ({{ v_cnt }})</a></div>
                {% for c in counties %}
                <div class="filter"><a href="?county={{ c.id }}">{{ c.title }} ({{ c.cnt }})</a></div>
                {% endfor %}
            </div>

        </div>
    </div>
    
    <div class="row">
        <div class="col-md-12">
            
            {% if all %}
                <h5>Rodomi paskutiniai 50 pranešimų iš visų seniūnijų</h5>
            {% else %}
            
                <h5>{{ county.title }}</h5>
                
                {% if county.subscription!='' %}
                
                {% endif %}
                
            {% endif %}
    
        </div>
    </div>
</div>


    <form method="get">
            <table class="table table-condensed">
                <tr>
                    <th width="130">Data</th>
                    <th width="250">Gavėjas</th>
                    <th>Tipas</th>
                    <th>Informacija</th>
                    {% if all %}
                    <th>Seniūnija</th>
                    {% endif %}
                    <th width="300">Adresas</th>
                </tr>
                <tr>
                    <th></th>
                    <th><input type="text" name="filter[receiver]" /></th>
                    <th></th>
                    <th><input type="text" name="filter[planned_work]" /></th>
                    {% if all %}
                    <th></th>
                    {% endif %}
                    <th width="300"><input type="text" name="filter[address]" /></th>
                </tr>
            {% for n in notifications %}
                <tr>
                    <td>{{ n.date|slice(0,16) }}</td>
                    <td>{{ n.receiver|e }}</td>
                    <td><div class="type {% if n.type=="Kirtimų leidimas" %}treePermit{% else %}planning{% endif %}" title="{{ n.content }}"></div></td>
                    <td>Dokumento numeris: {{ n.number }}:<br />{{ n.planned_work|raw }}</td>
                    {% if all %}
                    <td>{{ n.county }}</td>
                    {% endif %}
                    <td>{{ n.address }}, {{ n.address2 }}</td>
                </tr>
            {% endfor %}
            </table>
            <input type="submit" class="hide" />
        </form>